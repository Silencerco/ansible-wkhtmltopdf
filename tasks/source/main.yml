---
# file: wkhtmltopdf/tasks/source/main.yml
#
# tasks to install wkhtmltopdf using source.
#

- name: build | ensure build mandatory variables are set
  fail:
    msg="{{ item }} is a mandatory variable"
  when: "{{ item }} is not defined"
  with_items:
    - wkhtmltopdf_architecture
    - wkhtmltopdf_build
    - wkhtmltopdf_build_dependencies
    - wkhtmltopdf_dir_chroot
    - wkhtmltopdf_dir_install
    - wkhtmltopdf_dir_source
    - wkhtmltopdf_dir_source_version
    - wkhtmltopdf_download_url
    - wkhtmltopdf_force_build
    - wkhtmltopdf_slug
    - wkhtmltopdf_tarball

- name: build | install build dependencies
  action: "{{ ansible_pkg_mgr }} name={{ item }} state=present"
  with_items:
    - "{{ wkhtmltopdf_build_dependencies }}"
  become: yes

- include: "{{ wkhtmltopdf_build }}.yml"

- name: build | setup chroot environment
  shell: scripts/build.py setup-schroot-generic
  register: task_setup_chroot
  changed_when: not task_setup_chroot.stdout.find('skipped')
  args:
    chdir: "{{ wkhtmltopdf_dir_source_version }}"
  environment:
    WKHTMLTOX_CHROOT: "{{ wkhtmltopdf_dir_chroot }}"
  become: yes

- name: build | build binaries
  shell: "scripts/build.py linux-generic-{{ wkhtmltopdf_architecture }}"
  register: task_build
  changed_when: not task_build.stdout.find('Nothing to be done')
  args:
    chdir: "{{ wkhtmltopdf_dir_source_version }}"
  environment:
    WKHTMLTOX_CHROOT: "{{ wkhtmltopdf_dir_chroot }}"
  become_user: "{{ wkhtmltopdf_user }}"
  become: yes

- name: build | copy binaries
  copy:
    src="{{ wkhtmltopdf_dir_source_version }}/static-build/linux-generic-{{ wkhtmltopdf_architecture }}/app/bin/{{ item }}"
    dest="{{ wkhtmltopdf_dir_install }}"
    remote_src=yes
    owner=root
    group=root
    mode=0755
  become: yes
  with_items:
    - wkhtmltoimage
    - wkhtmltopdf
    - "libwkhtmltox.so.{{ wkhtmltopdf_version }}"
  become: yes

- name: build | create symlinks
  file:
    src="{{ wkhtmltopdf_dir_install }}/{{ item.src }}"
    dest="{{ wkhtmltopdf_dir_install }}/{{ item.dest }}"
    owner=root
    group=root
    mode=0755
    state=link
  become: yes
  with_items:
    - { src: "libwkhtmltox.so.{{ wkhtmltopdf_version }}", dest: "libwkhtmltox.so.{{ wkhtmltopdf_version.split('.')[0] }}" }
    - { src: "libwkhtmltox.so.{{ wkhtmltopdf_version }}", dest: "libwkhtmltox.so.{{ '.'.join(wkhtmltopdf_version.split('.')[0:2]) }}" }
    - { src: 'wkhtmltopdf', dest: "wkhtmltopdf-{{ wkhtmltopdf_version }}" }
    - { src: 'wkhtmltoimage', dest: "wkhtmltoimage-{{ wkhtmltopdf_version }}" }
